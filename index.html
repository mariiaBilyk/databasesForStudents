<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contacts search</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script
  		src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"
  		integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw="
 		crossorigin="anonymous">
	</script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>
<body>
	<div class="container">
		<div class="row">
		  <div class="col-xs-12 col-md-10">
		  	 <div class="panel panel-default">
		        <div class="panel-body">
		        <span class="pull-right clickable" data-effect="fadeOut"><i class="fa fa-times"></i></span>
		          
		        </div>
		    </div> 

		    <!-- Modal -->
			  <div class="modal fade" id="connectModal" role="dialog">
			    <div class="modal-dialog modal-sm">
			      <div class="modal-content">
			        <div class="modal-header">
			          <button type="button" class="close" data-dismiss="modal">&times;</button>
			          <h4 class="modal-title">Modal Header</h4>
			        </div>
			        <div class="modal-body">
			          <label for="sel1">Select table to connect:</label>
						  <select class="form-control" id="select-table">
						  </select>
						  <br>
						  <label for="sel2">Select connection type:</label>
						  <select required multiple class="form-control" id="select-connection-first">
						    <option>One</option>
						    <option>N</option>
						  </select>
						  <span>TO</span>
						  <select required multiple class="form-control" id="select-connection-second">
						    <option>One</option>
						    <option>N</option>
						  </select>
			        </div>
			        <div class="modal-footer">
			          <button type="button" class="btn btn-default connect-btn">OK</button>
			        </div>
			      </div>
			    </div>
			  </div>

		    <div class="database-area"><ul></ul></div>
		    <button type="button" class="btn btn-default check pull-right">Check</button>
		  </div>
		  <div class="col-xs-12 col-md-2 sidebar">
		  	<ul id="sortable">
			</ul>
		  </div>
		</div>
	</div>
	<script type="text/javascript" src="jquery.connect.js"></script>
	<script type="text/javascript" src="underscore.js"></script>
	<script type="text/javascript" src="db.json"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.min.js"></script>
	<script type="text/javascript">
	$('.clickable').on('click',function(){
		var effect = $(this).data('effect');
		$(this).closest('.panel')[effect]();
	});
	var connections = [];
	var rand;
    
    function connect(first_table,second_table,first_con_type,second_con_type){
    	connections.push(new $.connect(first_table, second_table, {container : '.database-area',leftLabel : first_con_type, rightLabel: second_con_type}));	
    }

	$.getJSON( "db.json", function(d) {
		}).done(function setRandomTest(data){
			rand = Math.floor(Math.random() * data.length);

			$(".panel-body").text(data[rand].text);

			$.each(data[rand].tables,function(i){
				var img = $('<img>');
				img.attr('src',data[rand].tables[i].filename);
				var list = $("<li class='ui-state-default drag'></li>").attr('id',data[rand].tables[i].id).append(img);
				
				$("#sortable").append(list);
			});
		});

	$(document).on("contextmenu",'.second',function(e) {
		e.preventDefault();
		var self = $(this);
		$('.second').each(function(){
			option = $('<option></option>').text($(this).attr("id"));
			$('#select-table').append(option);
		});
	
		$("#connectModal").modal();
		$('.connect-btn').one('click',function(){
			// alert("connect");
			var table_id = $('#select-table').val();
		
			
            connect('#'+self.attr("id"),'#'+table_id,$('#select-connection-first').val(),$('#select-connection-second').val());
            $("#connectModal").modal("hide");
		});
		 $("#connectModal").on('hidden.bs.modal', function(){
			$('#select-table').empty();
		 });
	});

	// _.intersectionObjects = function(array) {
	//     var slice = Array.prototype.slice;
	//     var rest = slice.call(arguments, 1);
	//     return _.filter(_.uniq(array), function(item) {
	//       return _.every(rest, function(other) {
	//         //return _.indexOf(other, item) >= 0;
	//         return _.any(other, function(element) { return _.isEqual(element, item); });
	//       });
	//     });
	//   };

	function checkAnswer(){
		var tablesToCheck = [];
		var tablesCorrect = [];
		var connectionsToCheck = [];
		var connectionsCorrect = [];
		$(document).find('.second').each(function(){
			tablesToCheck.push(parseInt($(this).attr("id")));
		});
		connections.forEach(function(connection){
				connectionsToCheck.push({
					"tableLeftId": parseInt(connection.elem1[0].id),
					"tableRightId": parseInt(connection.elem2[0].id),
					"relationType": connection.Connector[0].innerText
				});
		});

		$.getJSON( "db.json", function(d) {
		}).done(function (data){
			$.each(data[rand].tables,function(i){
				tablesCorrect.push(data[rand].tables[i].id);
			});
			$.each(data[rand].relations,function(i){
				connectionsCorrect.push(data[rand].relations[i]);
			});
			//var connectionsIntersect = _.intersectionObjects(connectionsToCheck, connectionsCorrect);
			var connectionsIntersect = _.intersectionWith(connectionsCorrect, connectionsToCheck, function (item1, item2) {
				if (item1.tableLeftId == item2.tableRightId && item1.tableRightId == item2.tableLeftId){
					switch(item1.relationType) {
						case "OneN":
							return item2.relationType == "NOne";
						case "NOne":
							return item2.relationType == "OneN";
						default:
							return item2.relationType == item1.relationType;
					}
				}
				return (item1.tableLeftId == item2.tableLeftId && item1.tableRightId == item2.tableRightId 
						&& item1.relationType == item2.relationType );
			});

			var tablesIntersect = _.intersection(tablesToCheck, tablesCorrect);
			//console.log(connectionsCorrect);
			// console.log(connectionsToCheck);
			var relationsPercentage;
			var tablesPercentage;
			if((connectionsToCheck.length-connectionsIntersect.length)
				+(connectionsCorrect.length-connectionsIntersect.length)/connectionsCorrect.length>=1){
				relationsPercentage = 0;
			}
			else 
				relationsPercentage = Math.floor((1 - ((connectionsToCheck.length-connectionsIntersect.length)
				+(connectionsCorrect.length-connectionsIntersect.length)/connectionsCorrect.length))*100);

			if((tablesToCheck.length-tablesIntersect.length)
				+(tablesCorrect.length-tablesIntersect.length)/tablesCorrect.length>=1){
				tablesPercentage = 0;
			}
			else 
				tablesPercentage = Math.floor((1 - ((tablesToCheck.length-tablesIntersect.length)
				+(tablesCorrect.length-tablesIntersect.length)/tablesCorrect.length))*100);

			console.log(tablesPercentage);
			console.log(relationsPercentage);
		});

		
	}

	$('.check').on('click',function(){
		checkAnswer();
	});

	$(document).on("contextmenu",'.connector',function(e) {
		e.preventDefault();
		var self = $(this);
		connections.forEach(function(connection, index, object){
			if(connection.Connector[0] === self[0]) {
				self.remove();
				object.splice(index,1);
			}
		});
	});
	$( function reset(){

	    $( ".drag" ).draggable({
	    	revert: "invalid",
	    	helper: "clone",
	    	appendTo: ".database-area",
	    });

	    $(".database-area ul").droppable({
	    	accept: ".drag , .second",
	    	activate: function(event, ui){
	    		$( ".second" ).draggable({
	    			helper: "original",
	    			// containment: ".database-area",
	    			drag : function recalculate() {
			    		
						var item = this;
						connections.forEach(function(connection){
							if(connection.elem1[0] === item || connection.elem2[0] === item) {
								connection.calculate();
							}
						});
					},
					stop: function(){
						var item = this;
						connections.forEach(function(connection){
							if(connection.elem1[0] === item || connection.elem2[0] === item) {
								connection.calculate();
							}
						});
					}
			    });		    	
	    	},

	    	drop: function(event, ui) {
               // $(this).removeClass("border").removeClass("over");
	            var dropped = ui.draggable;
	            var droppedOn = $(this);
	            $(dropped).detach().css({"top":ui.position.top,"left":ui.position.left}).addClass("second").removeClass("drag").appendTo(droppedOn);  
	            
            }

	    });

	    $(".sidebar").droppable({
	    	accept: ".drag , .second",
	    	drop: function(event, ui) {
                $(this).removeClass("border").removeClass("over");
	            var dropped = ui.draggable; 
	            var droppedOn = $(this).find("#sortable");
	            $(dropped).detach().css({"top":ui.position.top,"left":ui.position.left}).addClass("drag").removeClass("second").appendTo(droppedOn);
	            reset();
            }
	    });
	});
		    
			
		
	</script>
</body>
</html>